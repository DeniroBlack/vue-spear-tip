<template lang="pug">
  .vst-date-field(
    class="d-inline-block my1px w100% flex items-center flex-col relative"
    :class=`{
      // 'vst-select-multi': mode == 'multi' || mode == 'tags',
    }`
  )
    //div {{ VST.$r }}
    //@click="!$root.APP.hasTouchpad ? addDate() : null"
    //@touchstart="$root.APP.hasTouchpad ? addDate() : null"
    div(
      tabindex="-1"
      v-if="!value"
      @focusin="!disabled ? addDate() : null"
      @click="!disabled ? addDate() : null"
      class=`flex items-center min-w240px bg-white rounded-3xl justify-center text-#c1c7cf
          border-solid border-1px w100%
          mx-auto min-h46px!`
      :class=`{
        'hover:border-stone hover:text-stone border-#c1c7cf' : !disabled,
        'border-#D0CCC9FF cursor-no-drop' : disabled,
      }`
    ) {{ disabled ? '----' : (placeholder?.[localeInner] || placeholder?.en || placeholder) }}
    VSTStringField(
      v-if="value"
      :maskPreset
      :placeholder="(placeholder?.[localeInner] || placeholder?.en || placeholder)"
      class=`z2`
      @focus="_inputFocus()"
      @change="v => _changeInput(v)"
      @dateMaskChange="_dateMaskChange"
      :force12hours
      :dtPresetLocale="locale"
      :disabled
      fontSize="1rem"
      @keypress.enter="_inputEnter()"
      ref="VSTStringField"
    )
    div(class="cursor-pointer absolute op-0 t-0 l-50% translate-x--50%" v-show="value" )
      input(
        ref="picker"
        type="text"
        readonly
        @mousedown.prevent
      )
    div(
      class="w22px h22px text-stone absolute t-13px l-12px z4 cursor-pointer hover:scale-130"
      v-if="!disabled"
    )
      CalendarDaysIcon(
        @click="value ? _inputFocus() : addDate()"
      )
    component(is="style" v-if="!showCalendar") .flatpickr-calendar {display: none !important}
    component(is="style") .flatpickr-calendar {box-shadow: 0px 2px 13px var(--un-shadow-color, rgb(193 193 193)) !important}
    //div {{ value }}
</template>


<script lang="ts">

import {Temporal} from 'temporal-spec'
import {Computed, Prop, VST, VueClass, Watch} from '../../../core'
import FieldComponent from '../../../replaceable/FieldComponent.vue'
import FPLocales from 'flatpickr/dist/l10n'
import flatpickr from 'flatpickr'
import 'flatpickr/dist/flatpickr.min.css'
import { FlatpickrFn } from 'flatpickr/dist/types/instance' // @ts-ignore
import { Instance } from 'flatpickr/dist/types/instance'
import 'flatpickr/dist/plugins/confirmDate/confirmDate.css'
import confirmDatePlugin from 'flatpickr/dist/plugins/confirmDate/confirmDate.js'
import {StringField as VSTStringField} from '../../../kit'
import IDateField from './IDateField'
import { CalendarDaysIcon } from "@heroicons/vue/24/solid"

/**
 * Поле даты/даты-время с календарём и маской автоматически подстраивающеюся под локаль
 * @author CHORNY
 * @copyright https://smartrus.org
 */
@VST export default class DateField extends FieldComponent implements IDateField {
  components = {VSTStringField, CalendarDaysIcon}
  emits = ['change']
  declare $refs: {
    picker: HTMLElement
    VSTStringField: any
  }
  @Prop(String, Object) readonly placeholder: string|{[k:string]:string} = {
    en: 'Select date',
    ru: 'Нажмите для выбора даты',
  }
  @Prop(Boolean) readonly force12hours: boolean = false
  /** Добавить время */
  @Prop(Boolean) readonly withTime: boolean = false
  /** Добавить секунды */
  @Prop(Boolean) readonly withSeconds: boolean = false
  /**
   * value будет не строкой, а Temporal.ZonedDateTime
   * @see Temporal.ZonedDateTime
   */
  @Prop(String) readonly locale: string = ''
  @Prop(Boolean) readonly disabled: boolean = false
  @Prop(Boolean) readonly ISO861UTCMode: boolean = false
  value: number|string|null = null
  maxDateInner: string = ''
  minDateInner: string = ''
  localeInner: string = 'en'
  maskPreset: 'date'|'datetime'|'datetimeSec' = 'date'
  showCalendar: boolean = true
  DT: Temporal.ZonedDateTime|null = null
  beforeMount() {
    if (this.withTime) {
      this.maskPreset = 'datetime'
      if (this.withSeconds) {
        this.maskPreset = 'datetimeSec'
      }
    }
    this._initTemporalUpdateOut = true
    this.value = this.modelValue || this.inputValue || null
  }

  mounted() {
    this.nextTick(() => {
      this._initPicker()
      this.nextTick(() => {
        if (this.value) {
          this.addDate()
        }
      })
    })
  }
  /** Библиотека по работе  */
  private fp: Instance|null = null


  addDate() {
    const zonedDate = $VST.DT()
    const isNewVal: boolean = !!this.value
    this.$emit(
        'update:modelValue',
        this.value = this.value || (this.ISO861UTCMode ? zonedDate?.[
          this.maskPreset == 'date' ? 'toPlainDate' : 'toPlainDateTime'
        ]?.()?.toString().replace('T', ' ') : zonedDate.epochMilliseconds)
    )
    this.showCalendar = false
    setTimeout(() => {
      if (!this.fp) this._initPicker()
      this.fp?.open()
      this.fp?.close()
      this.nextTick(() => {
        if (!this.disabled && !isNewVal) this.$refs.VSTStringField?.focus?.()
        if (this.$refs?.picker) {
          setTimeout(() => {
            this.showCalendar = true
            this.$refs.picker.setAttribute('value', this._formatDate(new Date(zonedDate.epochMilliseconds)))
            this.fp?.setDate(new Date($VST.DT(this.value!).epochMilliseconds))
            if (!isNewVal) {
              this.fp?.open()
            }
          }, 250)
        }
      })
    }, 100)
  }

  private _extractDateOnly(dateString:string): string|null {
    const regex = /(\d{2,4}[./_-]\d{2,4}[./_-]\d{2,4})/
    const match = dateString.match(regex)
    if (match) return match?.[0] ?? null
    return null
  }

  private _preventMaskDateChange = false
  private _initPicker() {
    const locale = ((this.force12hours ? 'en-US'  : this.locale) || this.VST.$r.locale)
    const localeShort = locale?.split?.('-')?.[0]
    if (!this.$refs.picker || !localeShort) return
    this.localeInner = localeShort
    let pmHours: boolean
    try {
      const options = new Intl.DateTimeFormat(locale, { hour: 'numeric' }).resolvedOptions()
      pmHours = options.hourCycle === 'h11' || options.hourCycle === 'h12'
    } catch (e) {
      pmHours = false
    }
    // @ts-ignore
    this.fp = (flatpickr as FlatpickrFn)(this.$refs.picker as HTMLElement, {
      // defaultDate: $E.DT(this.value!).toString?.({ timeZoneName: 'never' })?.split?.('.')?.[0],
      enableTime: this.withTime,
      time_24hr: !pmHours,
      enableSeconds: this.withSeconds,
      weekNumbers: true,
      dateFormat: 'Y-m-d H:i:S', // Формат с секундами
      minDate: this.minDateInner,
      maxDate: this.maxDateInner,
      minuteIncrement: 1,
      secondsIncrement: 1,
      hoursIncrement: 1,
      allowInput: 1,
      closeOnSelect: false,
      className: 'custom-flatpickr-theme', // @ts-ignore
      locale: (localeShort ? FPLocales?.[localeShort] : FPLocales?.default) || FPLocales?.default || undefined, // @ts-ignore
      plugins: this.withSeconds || this.withTime ? [new confirmDatePlugin({
        confirmIcon: '',
        showAlways: true,
      })] : [],
      onValueUpdate: (dates: any) => {
        if (this._preventMaskDateChange) return this._preventMaskDateChange = false
        const time = dates?.[0]?.getTime?.() ?? 0
        if (time) {
          this._setInputMaskValueByDTStamp(time)
        }
      },
      onChange: (dates: any) => {
        // console.log('change', dates)
        // if (dates[0]) {
        //   let zonedDate = $VST.DT(dates[0].getTime())
        //   console.log(zonedDate)
        //   // Если включено время, но нет секунд, то сбрасываем последние до 00
        //   if (this.withTime && !this.withSeconds) {
        //     zonedDate = zonedDate.with({
        //       second: 0
        //     })
        //   }
        //   this.$emit(
        //       'update:modelValue',
        //       this.value = this.asTemporal
        //           ? zonedDate
        //           : (this.isMountedFromFormField
        //                   ? zonedDate.toString()
        //                   : this.parseTime(zonedDate)
        //           )
        //   )
        // }
      },
    })


    setTimeout(() => {
      if (this.value) {
        this._setInputMaskValueByDTStamp(this.value)
      }
    }, 150)
    // Установка начального значения если есть
    // if (this.value) {
    //   this.setValue(this.value)c
    // }
  }

  private _inputFocus() {
    // todo мобильной версии
    if (this.fp && !this.fp.isOpen) {
      this.fp.open()
    }
  }

  private _changeInput(val: string) {
    if (!val?.trim?.()) {
      this.$emit('update:modelValue', this.value = null)
    }
    if (this.fp && !this.fp.isOpen && !this.value) {
      this.fp.open()
    }
  }
  private _inputEnter(val: string) {
    if (this.fp && this.fp.isOpen) {
      this.fp.close()
    }
    this.$refs?.VSTStringField?.blur?.()
  }

  /**
   * Установка даты по вводимым данным из поля маски в
   * @param val
   * @private
   */
  private _dateMaskChange(val: {
    month: number|string, year: number|string, day: number|string, hour: number|string,
    minute: number|string, seconds: number|string, AmPm?: string
  })
  {
    let {month, year, day, hour, minute, seconds, AmPm} = val
    const dt = new Date
    if (!month) month = (dt.getMonth() + 1)
    if (!day) day = dt.getDate()
    if ((year?.toString?.()?.length ?? 0) < 4) year = dt.getFullYear()
    let isPm: null|boolean = null
    if (!hour && this.maskPreset != 'date') {
      hour = dt.getHours()
      if (hour == 23) hour = 0
      else ++hour
    }
    else {
      if (this.$refs.VSTStringField.is12hours) {
        hour = hour == 12 ? (
          AmPm == 'am' ? ((hour as number)-12) : hour
        ) : hour
      }
    }
    // console.log('AmPm', AmPm)

    const dtc = new Date(
        year as number, (month as number)-1, day as number,
        0, minute as number, seconds as number
    )
    dtc.setHours(hour as number)
    if (this.fp) {
      this.fp.setDate(dtc)
      if (this.maskPreset == 'date') {
        this.nextTick(() => this.fp?.close?.())
      }
    }
  }

  private parseTime(time: any): string {
    return time.toString().split('+')[0].split('.')[0]
      .replace('T', ' ').split(
        this.withTime ? '!' : ' '
      )[0]
  }

  private _formatDate(time: Date): string {
    const month = new Intl.DateTimeFormat('ru-RU', { month: 'short', day: 'numeric' }).format(
        time
    ).replace(/\d+\s?/, '')
    const date = $VST.DT(time.getTime())
    return `${date.day} ${month} ${date.year}`+
        (this.withTime
                ? ` в ${date.hour.toString().padStart(2, '0')}:${date.minute.toString().padStart(2, '0')}`
                : ''
        )+
        (this.withSeconds ? `:${date.second.toString().padStart(2, '0')}` : '')
  }

  private _setInputMaskValueByDTStamp(stamp: number|string) {
    this.DT = $VST.DT(stamp)
    this.$emit(
      'update:modelValue',
      this.value = this.ISO861UTCMode ? this.DT?.[
        this.maskPreset == 'date' ? 'toPlainDate' : 'toPlainDateTime'
      ]?.()?.toString().replace('T', ' ') : this.DT.epochMilliseconds
    )
    let val = this.DT.toLocaleString(
        (this.locale || new Intl.DateTimeFormat().resolvedOptions().locale), {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: this.maskPreset == 'datetime' || this.maskPreset == 'datetimeSec' ? '2-digit' : undefined,
          minute: this.maskPreset == 'datetime' || this.maskPreset == 'datetimeSec' ? '2-digit' : undefined,
          second: this.maskPreset == 'datetimeSec' ? '2-digit' : undefined,
        }
    )
    if (this.maskPreset == 'date') {
      val = this._extractDateOnly(val) ?? ''
    }
    val = val.trim().replace(/\s+/g, ' ')
    this.$refs.VSTStringField.setValue(val)
  }

  private _initTemporalUpdateOut: boolean = false
  onValueChange() {
    this._initTemporalUpdateOut = true
    this.DT = $VST.DT(this.value || undefined)
  }

  @Watch('DT', true, true) _watchDT(DT: Temporal.ZonedDateTime|null) {
    if (this._initTemporalUpdateOut) return this._initTemporalUpdateOut = false
    this._initTemporalUpdateOut = true
    if (DT) this.value = this.ISO861UTCMode ? DT?.[
      this.maskPreset == 'date' ? 'toPlainDate' : 'toPlainDateTime'
    ]?.()?.toString().replace('T', ' ') : DT.epochMilliseconds
    else this.value = null
    this.$emit('update:modelValue', this.value)
  }
}

</script>


<style lang="sass">

//Основные стили поля
.vst-date-field
  @apply w-full relative select-none!

  .flatpickr-input
    @apply select-none! hover:text-stone-500 hover:underline hover:border-#d6ff63 min-w230px min-h52px! w100%
    div
      @apply select-none!
    &.active
      @apply border-#d6ff63! border-width-1px! shadow-none! outline-solid-stone outline-2px

  input
    @apply px-5px rounded border bg-white cursor-pointer rounded-3xl! min-w240px 1rem! h28px! py0
    @apply user-select-none w[calc(100%-12px)]
    @apply border-1px border-#c1c7cf border-solid text-center
    @apply disabled:(bg-gray-100 cursor-not-allowed)
    &:focus
      @apply border-#d6ff63! border-width-1px shadow-none! outline-solid-stone outline-2px
    &.is-invalid
      @apply border-red-500


.flatpickr-calendar
  @apply w320px! rounded-3xl shadow-[0px_2px_13px_#c1c1c1]! border-color-#ededed! px10px z9999!
  .flatpickr-day.today
    @apply bg-lightblue-500 border-lightblue-600 text-lightblue-100 op-80
    @apply hover:bg-lightblue-400 hover:border-lightblue-400
  //.flatpickr-day.selected
  //  @apply bg-red-400 border-red-500 hover:bg-red-500 hover:border-red-200
  .flatpickr-day.selected.today, .flatpickr-day.selected
    @apply bg-lime-400! border-stone-500! text-black! hover:bg-stone-300! hover:border-stone-400!
    @apply hover:text-emerald-700!
  .flatpickr-day.selected.today
    @apply fw-bold!

  .flatpickr-months
    @apply flex! items-center justify-center pt1px
    .flatpickr-prev-month, .flatpickr-next-month
      @apply flex! items-center! justify-center!
    .flatpickr-prev-month
      @apply ml20px h40px p0
    .flatpickr-next-month
      @apply mr20px h40px p0
  .flatpickr-monthDropdown-months
    @apply flex items-center justify-center h25px! fs-16px! overflow-hidden!
  .flatpickr-current-month
    @apply flex items-center justify-center h25px!
  &.open
    @apply z9999!
  .flatpickr-confirm.visible
    @apply bg-lime! rounded-3xl! mb10px mt4px
.numInputWrapper, .numInputWrapper input, .flatpickr-current-month, .flatpickr-time-separator
  @apply h25px! lh-25px!
.numInput
  @apply h28px! fs-16px!
.numInputWrapper, .numInput
  @apply min-w70px!

.flatpickr-time
  @apply h38px! pt6px
  input
    @apply hover:bg-gray-100!
    &.flatpickr-hour
      @apply hover:bg-gray-100!
    &.flatpickr-minute
      @apply hover:bg-gray-100!

.flatpickr-innerContainer
  @apply flex items-center justify-center
  .flatpickr-days
    @apply pb8px px5px w235px!
    .flatpickr-day
      @apply w25px! h25px! lh-25px! mb2px! fs-13px
  .flatpickr-weeks
    @apply self-start mb3px rounded-b-3xl flex items-start justify-start flex-column
    .flatpickr-day
      @apply max-w25px! h28px! lh-27px! mb2px! text-gray-500! op-80
      &:last-child
        @apply pb0! mb0!
  .flatpickr-weekwrapper
    @apply flex items-start justify-start flex-column self-start bg-#e4e4e4 mt3px rounded-b-2xl
    @apply rounded-tl-2xl
    .flatpickr-weekdays
      @apply w200px!
    .flatpickr-weekday
      @apply max-w25px! h17px! lh-17px! mt3px text-gray-400! flex items-end justify-end h24px pb3px pt2px d-block
      @apply ml7px rounded-tl-14px op-70
  .flatpickr-weekdaycontainer
    @apply pb4px pt5px px11px grid! grid-cols-7! gap-1! items-center justify-items-center bg-#e4e4e4 rounded-r-3xl
    .flatpickr-weekday
      @apply text-gray-400! self-start text-gray-500! op-80
  .dayContainer
    @apply py4px px5px grid grid-cols-7 gap-1 items-center justify-items-center w240px! max-w240px! min-w-auto!


// Кастомизация flatpickr
//// Важно: уберите scoped чтобы стили применились к элементам flatpickr
.custom-flatpickr-theme
  @apply bg-white rounded-lg! shadow-lg! border! border-#c1c7cf!
  &.has-event
    @apply fw-bold

  &.selected
    @apply bg-blue-500 text-white border-blue-500 fs-13px!
    @apply hover:(bg-blue-600)
//
//  // Заголовок с месяцем/годом
//  .flatpickr-current-month
//    @apply text-gray-800 font-medium
//
//  // Дни недели
//  .flatpickr-weekday
//    @apply text-gray-500 font-normal
//
//  // Ячейки с датами
//  .flatpickr-day
//    @apply text-gray-700 rounded-full
//    @apply hover:(bg-blue-50)

//
//    &.today
//      @apply border-blue-500
//
//    &.disabled
//      @apply text-gray-300 cursor-not-allowed
//      @apply hover:(bg-transparent)
//
//  // Время
//  .flatpickr-time
//    @apply border-t border-gray-200
//
//    input
//      @apply text-gray-700 font-medium
//      @apply focus:(ring-0 border-0)
//
//    .flatpickr-am-pm
//      @apply text-gray-500
//      @apply hover:(bg-gray-50)
//
//  // Стрелки навигации
//  .flatpickr-months
//    .flatpickr-prev-month, .flatpickr-next-month
//      @apply text-gray-400 p-2
//      @apply hover:(text-blue-500)
//
//      svg
//        @apply w-5 h-5
//
//  // Время
//  .numInputWrapper
//    @apply hover:(bg-gray-50)
//
//    &:hover
//      .arrowUp, .arrowDown
//        @apply opacity-100
//
//    .arrowUp, .arrowDown
//      @apply opacity-0 transition-opacity
//      @apply hover:(text-blue-500)
//
//  // Анимация появления
//  &.open
//    @apply animate-fadeIn
</style>
